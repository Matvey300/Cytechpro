import requests
import pandas as pd

API_KEY = "6888b22c09c987d9f10c066e"
SEARCH_TERM = "bluetooth headphones"
DOMAIN = "com"  # Amazon US
PAGE = 1

def extract_asin_from_url(url):
    try:
        parts = url.split("/dp/")
        if len(parts) > 1:
            return parts[1].split("/")[0]
    except:
        return None

def fetch_search_results(search_term, domain, page):
    query = search_term.replace(" ", "+")
    url = (
        f"https://api.scrapingdog.com/amazon/search?"
        f"api_key={API_KEY}&query={query}&domain={domain}&page={page}"
    )

    response = requests.get(url)
    print(f"Fetching {domain} page {page} — status: {response.status_code}")

    if response.status_code != 200:
        print("Error:", response.text)
        return []

    data = response.json().get("results", [])
    items = []

    for product in data:
        if product.get("type") != "search_product":
            continue

        asin = extract_asin_from_url(product.get("url", ""))
        if asin:
            items.append({
                "asin": asin,
                "title": product.get("title"),
                "rating": product.get("stars"),
                "review_count": product.get("total_reviews"),
                "country": domain
            })

    return items

# Run test
results = fetch_search_results(SEARCH_TERM, DOMAIN, PAGE)

# Save to CSV
df = pd.DataFrame(results)
df.to_csv("test_search_results.csv", index=False)
print(f"✅ Saved {len(df)} products to test_search_results.csv")
